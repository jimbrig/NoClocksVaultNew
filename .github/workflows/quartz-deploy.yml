name: Deploy Quartz to GitHub Pages

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

on:
  push:
    branches:
      - develop
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: develop

      - name: Setup Quartz
        run: |
          echo "Cloning Quartz..."
          git clone --depth 1 https://github.com/jackyzha0/quartz.git quartz-src
          
      - name: Apply configurations
        run: |
          # copy quartz config files
          cp quartz.config.ts quartz.layout.ts quartz-src/
          
          # setup content directory
          mkdir -p quartz-src/content
          
          # copy all vault content (raw obsidian with wikilinks)
          rsync -av \
            --exclude='quartz/' \
            --exclude='quartz-src/' \
            --exclude='quartz.config.ts' \
            --exclude='quartz.layout.ts' \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='.obsidian/' \
            --exclude='.cursor/' \
            --exclude='.scripts/' \
            --exclude='99-ARCHIVES/' \
            . quartz-src/content/

      - name: Setup favicons
        run: |
          mkdir -p quartz-src/static
          if [ -d "05-SYSTEM/Assets/Favicons" ]; then
            cp 05-SYSTEM/Assets/Favicons/favicon.ico quartz-src/static/ 2>/dev/null || true
            cp 05-SYSTEM/Assets/Favicons/favicon-16x16.png quartz-src/static/ 2>/dev/null || true
            cp 05-SYSTEM/Assets/Favicons/favicon-32x32.png quartz-src/static/ 2>/dev/null || true
            cp 05-SYSTEM/Assets/Favicons/apple-touch-icon.png quartz-src/static/ 2>/dev/null || true
            cp 05-SYSTEM/Assets/Favicons/android-chrome-96x96.png quartz-src/static/icon.png 2>/dev/null || true
            echo "Favicons copied to static folder"
          fi

      - name: Prepare content for Quartz
        run: |
          cd quartz-src/content
          
          # use README.md as homepage (copy to index.md)
          if [ -f "README.md" ]; then
            cp README.md index.md
            echo "Homepage created from README.md"
          fi
          
          # rename _README.md to index.md for folder indexes
          find . -name '_README.md' -execdir mv {} index.md ";"
          
          # strip dataview/dataviewjs blocks (Quartz can't execute them)
          find . -name "*.md" -type f | while read -r file; do
            perl -i -0pe '
              # replace dataview/dataviewjs blocks with placeholder
              s/`{3,4}dataview(js)?.*?`{3,4}//gs;
              
              # replace table-of-contents blocks (Quartz has its own TOC)
              s/`{3,4}table-of-contents.*?`{3,4}//gs;
              
              # replace inline dataview: `$= dv.xxx(...)`
              s/\*?\*?`\$= dv\.[^`]+`\*?\*?//g;
            ' "$file"
          done
          
          echo "Content prepared for Quartz"
          echo "Total markdown files: $(find . -name '*.md' | wc -l)"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: quartz-src/package-lock.json

      - name: Install Node.js dependencies
        working-directory: quartz-src
        run: npm ci

      - name: Build website
        run: npx quartz build
        working-directory: quartz-src

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: quartz-src/public

  deploy:
    needs: build
    permissions:
      pages: write
      id-token: write
      actions: read
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
