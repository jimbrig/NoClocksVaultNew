name: Convert Obsidian Vault

on:
  push:
    branches:
      - develop
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Rename _README files
        run: |
          find . -name '_README.md' -not -path "./.git/*" | while read -r file; do
            dir=$(dirname "$file")
            mv "$file" "$dir/README.md"
            echo "Renamed: $file -> $dir/README.md"
          done

      - name: Convert wikilinks to markdown links
        run: |
          # Convert [[Note]] to [Note](Note.md)
          # Convert [[Note|Alias]] to [Alias](Note.md)
          # Convert [[folder/Note]] to [Note](folder/Note.md)
          
          find . -name "*.md" -type f -not -path "./.git/*" | while read -r file; do
            # Get the directory of the current file for relative path calculation
            file_dir=$(dirname "$file")
            
            # Simple wikilink: [[Note]] -> [Note](Note.md)
            perl -i -pe 's/\[\[([^\]|#]+)\]\]/[$1]($1.md)/g' "$file"
            
            # Aliased wikilink: [[Note|Alias]] -> [Alias](Note.md)
            perl -i -pe 's/\[\[([^\]|#]+)\|([^\]]+)\]\]/[$2]($1.md)/g' "$file"
            
            # Wikilink with heading: [[Note#Heading]] -> [Note](Note.md#Heading)
            perl -i -pe 's/\[\[([^\]|#]+)#([^\]|]+)\]\]/[$1]($1.md#$2)/g' "$file"
            
            # Wikilink with heading and alias: [[Note#Heading|Alias]] -> [Alias](Note.md#Heading)
            perl -i -pe 's/\[\[([^\]|#]+)#([^\]|]+)\|([^\]]+)\]\]/[$3]($1.md#$2)/g' "$file"
            
            # Fix _README references -> README
            sed -i 's/_README\.md/README.md/g' "$file"
            sed -i 's/_README]/README]/g' "$file"
            
            # Fix path separators (backslash to forward slash)
            sed -i 's|\\|/|g' "$file"
          done
          
          echo "Converted wikilinks to markdown links"

      - name: Strip Obsidian plugin blocks
        run: |
          find . -name "*.md" -type f -not -path "./.git/*" -exec perl -i -0pe '
            s/\n*```+dataview(js)?.*?```+\n*/\n<!-- dynamic content -->\n/gs;
            s/\n*```+table-of-contents.*?```+\n*/\n/gs;
            s/\*?\*?`\$= dv\.[^`]+`\*?\*?//g;
          ' {} \;
          echo "Stripped plugin blocks"

      - name: Remove embed syntax
        run: |
          # Convert ![[embed]] to just a link
          find . -name "*.md" -type f -not -path "./.git/*" | while read -r file; do
            sed -i 's/!\[\[/[[/g' "$file"
          done
          echo "Converted embeds to links"

      - name: Commit and Push Changes
        if: github.event_name != 'pull_request'
        uses: actions-js/push@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          author_email: dev@noclocks.dev
          author_name: 'No Clocks Bot'
          message: 'chore: convert to GitHub-compatible markdown'
          branch: main
          force: true
