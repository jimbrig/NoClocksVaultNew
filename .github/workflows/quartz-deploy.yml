name: Deploy Quartz to GitHub Pages

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

on:
  push:
    branches:
      - develop
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: develop

      - name: Setup Quartz
        run: |
          echo "Cloning Quartz..."
          git clone --depth 1 https://github.com/jackyzha0/quartz.git quartz-src

      - name: Copy vault content
        run: |
          cp quartz.config.ts quartz.layout.ts quartz-src/
          mkdir -p quartz-src/content
          rsync -av \
            --exclude='quartz/' \
            --exclude='quartz-src/' \
            --exclude='quartz.config.ts' \
            --exclude='quartz.layout.ts' \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='.obsidian/' \
            --exclude='.cursor/' \
            --exclude='.scripts/' \
            --exclude='99-ARCHIVES/' \
            --exclude='05-SYSTEM/Templates/' \
            . quartz-src/content/

      - name: Setup favicons
        run: |
          mkdir -p quartz-src/static
          cp 05-SYSTEM/Assets/Favicons/favicon.ico quartz-src/static/ || true
          cp 05-SYSTEM/Assets/Favicons/favicon-16x16.png quartz-src/static/ || true
          cp 05-SYSTEM/Assets/Favicons/favicon-32x32.png quartz-src/static/ || true
          cp 05-SYSTEM/Assets/Favicons/apple-touch-icon.png quartz-src/static/ || true
          cp 05-SYSTEM/Assets/Favicons/android-chrome-96x96.png quartz-src/static/icon.png || true
          ls -la quartz-src/static/ || echo "No static files"

      - name: Create homepage
        run: |
          cd quartz-src/content
          if [ -f "README.md" ]; then
            cp README.md index.md
            echo "Created index.md from README.md"
          fi

      - name: Rename _README files to index
        run: |
          cd quartz-src/content
          find . -name '_README.md' | while read -r file; do
            dir=$(dirname "$file")
            mv "$file" "$dir/index.md"
            echo "Renamed: $file -> $dir/index.md"
          done

      - name: Fix _README links in content
        run: |
          cd quartz-src/content
          # Replace _README references with index in wikilinks
          find . -name "*.md" -type f -exec sed -i 's/_README/index/g' {} \;
          echo "Fixed _README links"

      - name: Strip Obsidian plugin blocks
        run: |
          cd quartz-src/content
          find . -name "*.md" -type f -exec perl -i -0pe '
            s/\n*```+dataview(js)?.*?```+\n*/\n/gs;
            s/\n*```+table-of-contents.*?```+\n*/\n/gs;
            s/\*?\*?`\$= dv\.[^`]+`\*?\*?//g;
          ' {} \;
          echo "Stripped plugin blocks"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: quartz-src/package-lock.json

      - name: Install dependencies
        working-directory: quartz-src
        run: npm ci

      - name: Copy favicons to static folder (after npm install)
        run: |
          # ensure favicon files are in quartz-src/static (overwrites any defaults)
          mkdir -p quartz-src/static
          cp -f 05-SYSTEM/Assets/Favicons/favicon.ico quartz-src/static/
          cp -f 05-SYSTEM/Assets/Favicons/favicon-16x16.png quartz-src/static/
          cp -f 05-SYSTEM/Assets/Favicons/favicon-32x32.png quartz-src/static/
          cp -f 05-SYSTEM/Assets/Favicons/apple-touch-icon.png quartz-src/static/
          cp -f 05-SYSTEM/Assets/Favicons/android-chrome-96x96.png quartz-src/static/icon.png
          echo "Favicons in static folder:"
          ls -la quartz-src/static/

      - name: Build Quartz
        working-directory: quartz-src
        run: npx quartz build
      
      - name: Verify static files in public
        run: |
          echo "Static files in public folder:"
          ls -la quartz-src/public/ | head -20 || true
          ls -la quartz-src/public/static/ || echo "No static folder"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: quartz-src/public

  deploy:
    needs: build
    permissions:
      pages: write
      id-token: write
      actions: read
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
