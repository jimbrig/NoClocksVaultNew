name: Convert Obsidian Vault

on:
  push:
    branches:
      - develop
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Rename _READMEs
        run: |
          find . -name '*_README.md' -execdir mv -i {} README.md ";"

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Setup Cargo Cache
        uses: actions/cache@v4
        continue-on-error: false
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Install obsidian-export
        run: cargo install --locked obsidian-export || true

      - name: Run obsidian-export
        run: |
          mkdir tmp
          obsidian-export . tmp --frontmatter never
          # copy exported files back (preserving directory structure)
          cp -r tmp/* . -f
          rm -r tmp

      - name: Strip Obsidian Plugin Blocks
        run: |
          # strip dataview, dataviewjs, and table-of-contents blocks
          # also replaces inline dataview queries with placeholders
          
          find . -name "*.md" -type f -not -path "./.git/*" | while read -r file; do
            # use perl for more reliable multiline regex handling
            perl -i -0pe '
              # replace dataview/dataviewjs blocks with placeholder comment
              s/`{3,4}dataview(js)?.*?`{3,4}/<!-- dataview query removed for github compatibility -->/gs;
              
              # replace table-of-contents blocks with placeholder
              s/`{3,4}table-of-contents.*?`{3,4}/<!-- table of contents removed for github compatibility -->/gs;
              
              # replace inline dataview: `$= dv.xxx(...)` with optional bold markers
              s/\*?\*?`\$= dv\.[^`]+`\*?\*?/*(dynamic content)*/g;
            ' "$file"
          done
          
          echo "Stripped Obsidian plugin blocks"

      - name: Commit and Push Changes
        if: github.event_name != 'pull_request'
        uses: actions-js/push@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          author_email: dev@noclocks.dev
          author_name: 'No Clocks Bot'
          message: 'chore: convert wikilinks, rename READMEs, strip plugin blocks'
          branch: main
          force: true
