name: Convert Obsidian Vault

on:
  push:
    branches:
      - develop
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Cargo Cache
        uses: actions/cache@v4
        continue-on-error: false
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-obsidian-export
          restore-keys: ${{ runner.os }}-cargo-

      - name: Install obsidian-export
        run: |
          if ! command -v obsidian-export &> /dev/null; then
            cargo install --locked obsidian-export
          fi

      - name: Rename _READMEs to README
        run: |
          find . -name '_README.md' -not -path "./.git/*" | while read -r file; do
            dir=$(dirname "$file")
            mv "$file" "$dir/README.md"
            echo "Renamed: $file -> $dir/README.md"
          done

      - name: Run obsidian-export
        run: |
          mkdir -p tmp
          # export with frontmatter preserved
          obsidian-export . tmp --frontmatter always 2>&1 | head -100 || true
          
          # copy exported files back
          rsync -av --remove-source-files tmp/ . || cp -r tmp/* . 2>/dev/null || true
          rm -rf tmp
          
          echo "Export complete"

      - name: Fix link paths and cleanup
        run: |
          find . -name "*.md" -type f -not -path "./.git/*" | while read -r file; do
            # fix backslashes in markdown links (Windows path issue)
            sed -i 's|\\|/|g' "$file"
            
            # fix URL-encoded spaces in local links
            # convert ](%20 to ](  for readability (optional)
            
            # remove any remaining unconverted wikilinks - make them italic instead
            # [[Note Name]] -> *Note Name*
            perl -i -pe 's/\[\[([^\]|]+)\]\]/*$1*/g' "$file"
            
            # handle aliased wikilinks [[Note|Alias]] -> *Alias*
            perl -i -pe 's/\[\[[^\]|]+\|([^\]]+)\]\]/*$1*/g' "$file"
          done
          
          echo "Link paths fixed"

      - name: Strip Obsidian Plugin Blocks
        run: |
          find . -name "*.md" -type f -not -path "./.git/*" | while read -r file; do
            perl -i -0pe '
              # remove dataview/dataviewjs blocks
              s/\n*```+dataview(js)?.*?```+\n*/\n<!-- dynamic content -->\n/gs;
              
              # remove table-of-contents blocks
              s/\n*```+table-of-contents.*?```+\n*/\n/gs;
              
              # remove inline dataview queries
              s/\*?\*?`\$= dv\.[^`]+`\*?\*?//g;
            ' "$file"
          done
          
          echo "Stripped Obsidian plugin blocks"

      - name: Commit and Push Changes
        if: github.event_name != 'pull_request'
        uses: actions-js/push@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          author_email: dev@noclocks.dev
          author_name: 'No Clocks Bot'
          message: 'chore: convert wikilinks for GitHub compatibility'
          branch: main
          force: true
