name: Deploy Quartz to GitHub Pages

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

on:
  push:
    branches:
      - main
  workflow_run:
    workflows: ["Convert Obsidian Vault"]
    types:
      - completed
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Setup Quartz
        run: |
          if [ ! -d "quartz" ]; then
            echo "Cloning Quartz..."
            git clone --depth 1 https://github.com/jackyzha0/quartz.git quartz
          fi

      - name: Apply configurations
        run: |
          cp quartz.config.ts quartz.layout.ts quartz/
          mkdir -p quartz/content
          # copy all vault content except quartz submodule and config files
          rsync -av --exclude='quartz/' --exclude='quartz.config.ts' --exclude='quartz.layout.ts' --exclude='.git/' --exclude='.github/' . quartz/content/

      - name: Prepare content for Quartz
        run: |
          cd quartz/content
          
          # rename _README.md to index.md for folder indexes
          find . -name '_README.md' -execdir mv -i {} index.md ";"
          
          # strip dataview/dataviewjs blocks
          find . -name "*.md" -type f | while read -r file; do
            perl -i -0pe '
              # replace dataview/dataviewjs blocks with placeholder
              s/`{3,4}dataview(js)?.*?`{3,4}/<!-- dataview query - see source vault -->/gs;
              
              # replace table-of-contents blocks with placeholder
              s/`{3,4}table-of-contents.*?`{3,4}/<!-- toc generated by quartz -->/gs;
              
              # replace inline dataview: `$= dv.xxx(...)`
              s/\*?\*?`\$= dv\.[^`]+`\*?\*?//g;
            ' "$file"
          done
          
          echo "Content prepared for Quartz"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: quartz/package-lock.json

      - name: Install Node.js dependencies
        working-directory: quartz
        run: npm ci --omit=dev

      - name: Build website
        run: npx quartz build
        working-directory: quartz

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: quartz/public

  deploy:
    needs: build
    permissions:
      pages: write
      id-token: write
      actions: read
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

